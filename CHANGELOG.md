大量重构，添加fabric支持，功能基本不变